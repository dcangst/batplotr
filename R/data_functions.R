#' read Batscope export
#' 
#' reads the \code{xlsx} generated by the batscope export
#'
#' @param path filename
#' @param quality_threshold sequences with species assignment quality below this
#'  threshold will be discarded.
#' @param quality_name what is the name of the column which contains the
#'  relevant quality scores
#' @family data functions
#' @export
readBatscopeXLSX <- function(path,
        quality_threshold=0.8,
        quality_name="AutoClass1Qual"){

    rohdaten <- openxlsx::read.xlsx(file_name, sheet = 1, 
        startRow = 1, colNames = TRUE, 
        skipEmptyRows = TRUE, rowNames = FALSE, 
        detectDates = FALSE, rows = NULL, cols = NULL)
    dateOrigin <- openxlsx::getDateOrigin(file_name)
    #str(rohdaten)

    # MODIFY DATA for use in R
    daten <- rohdaten

    # discard sequences with low quality
    dim_qual_before <- dim(rohdaten)
    quality_colnr <- which(colnames(daten) == quality_name)
    daten <- subset(daten,daten[,quality_colnr]>quality_threshold)
    dim_qual_after <- dim(daten)
    dim_qual_diff <- dim_qual_before[1]-dim_qual_after[1]

    cat("Discarded ",dim_qual_diff," of ",
        dim_qual_before[1]," sequences (",
        (dim_qual_diff/dim_qual_before[1])*100,"%); ",dim_qual_after[1],
        " remaining\n",sep="")

    # convert data/time format from excel to R
    daten$ImportDate <- openxlsx::convertToDateTime(rohdaten$ImportDate, 
        origin = dateOrigin)
    #fix subtle difference in POSIXct representation that messes with 
    #some functions
    daten$ImportDate <- as.POSIXct(as.character(daten$ImportDate)) 
    
    daten$SurveyDate <- openxlsx::convertToDateTime(rohdaten$SurveyDate, 
        origin = dateOrigin)
    #fix, see above
    daten$SurveyDate <- as.POSIXct(as.character(daten$SurveyDate)) 
    
    daten$recDate <- openxlsx::convertToDateTime(rohdaten$recDate, origin = dateOrigin)
    #fix, see above
    daten$recDate <- as.POSIXct(as.character(daten$recDate)) 

    daten$recTime <- openxlsx::convertToDateTime(rohdaten$recTime+rohdaten$recDate, 
        origin = dateOrigin)
    #fix, see above
    daten$recTime <- as.POSIXct(as.character(daten$recTime)) 

    # convert chr to factor for easier handling in R
    daten$species <- factor(daten$species)

    return(daten)
}