#' Night Plot
#' 
#' Plot activity (number of calls) over one night.
#'
#' @param plotData data generated by \code{\link{sumBatscopeData}}
#' @param day day to plot in POSIXct format or "YYYY-MM-DD", defaults to first
#'   date in \code{plotData}
#' @param sel_species species name or vector of species to plot, use "every" to 
#'   plot all species individually (differentiated by color)
#' @param x_limits x-axis limits, NULL (default) or a POSIXct vector of length 2 
#' @param y_limits y-axis limits, NULL (default) or a numeric vector of length 2 
#' @return a \code{ggplot} object
#' @family plot functions
#' @export
nightPlot <- function(plotData, 
  day=min(plotData$SurveyDate),
  sel_species="every",
  x_limits=NULL,
  y_limits=NULL){

  if(is.POSIXct(day)==FALSE){
    day <- as.POSIXct(day,format="%Y-%m-%d")
  }
  
  if(sel_species[1]=="every"){
    plotData_sub <- subset(plotData,SurveyDate %in% day & species!="all")
  } else {
    plotData_sub <- subset(plotData,SurveyDate %in% day & 
      species %in% sel_species)
  }

  if(is.null(x_limits)){
    x_limits <- c(min(plotData_sub$sunset)-0.5*3600,
      max(plotData_sub$sunrise)+0.5*3600)
  }
  
  if(is.null(y_limits)){
    y_limits <- c(0,max(plotData_sub$n_events))
  }

  plottitle <- paste("Aktivität (# Sequencen)",str_c(format(day,format="%d.%m.%Y"),collapse=" - "))

  nightPlot <- ggplot(plotData_sub,aes(bins,n_events,fill=species))+
    facet_wrap(~ProjectName, ncol = 2)+
    geom_bar(stat="identity",position="dodge",width=300)+
    geom_vline(aes(xintercept=as.numeric(sunset)),
      colour="orange")+
    geom_vline(aes(xintercept=as.numeric(sunrise)),
      colour="orange")+
    scale_x_datetime(limits=x_limits, breaks=date_breaks("2 hour"),
      minor_breaks=date_breaks("1 hour"),
      labels = date_format("%H:%M"))+
    scale_y_continuous(limits=y_limits,breaks=seq(0,max(y_limits),2))+
    labs(x="Uhrzeit",y="Aktivität (# Events)",title=plottitle)

  return(nightPlot)
  }

#' Period Plot
#' 
#' Plot activity (number of calls) of each night of a given period.
#'
#' @param plotData data generated by \code{\link{sumBatscopeData}}
#' @param start_date in POSIXct format or \code{"YYYY-MM-DD"}, defaults to the
#'   beginning of the year in which the first data were aquired.
#' @param end_date in POSIXct format or \code{"YYYY-MM-DD"}, defaults to the end
#'   of the year in which the last data were aquired.
#' @param sel_species species_name or vector of species to plot, use "every" to 
#'   plot all species individually (differentiated by color)
#' @param x_limits x-axis limits, NULL (default) or a POSIXct vector of length 2 
#' @param y_limits y-axis limits, NULL (default) or a character or POSIXct 
#'   vector of length 2 with format
#'   \code{c("1900-01-01 HH:MM","1900-01-02 HH:MM")}
#' @param plotTitle character, title for plot. \code{NULL} for default title. 
#' @return a \code{ggplot} object
#' @family plot functions
#' @export
periodPlot <- function(plotData, 
  start_date=floor_date(min(plotData$SurveyDate),"year"),
  end_date=ceiling_date(max(plotData$SurveyDate),"year"),
  sel_species="every",
  x_limits=NULL,
  y_limits=NULL,
  plotTitle=NULL){

  if(is.POSIXct(start_date)==FALSE){
    start_date <- as.POSIXct(start_date,format="%Y-%m-%d")
  }
  if(is.POSIXct(end_date)==FALSE){
    end_date <- as.POSIXct(end_date,format="%Y-%m-%d")
  }

  if(!is.null(y_limits) & is.POSIXct(y_limits)[1]==FALSE){
    y_limits <- as.POSIXct(y_limits)
  }

  cat("Plotting number of sequences over period:\n")
  print(new_interval(start_date, end_date))
  if(sel_species[1]=="every"){
    plotData_sub <- subset(plotData,
      SurveyDate %within% new_interval(start_date, end_date) &
      species!="all")
    plottitle <- paste("Tagesaktivität",format(start_date,format="%d.%m.%Y"),
      "bis",format(end_date,format="%d.%m.%Y"),"| Summe aller Spezies")
  } else {
    plotData_sub <- subset(plotData,
      SurveyDate %within% new_interval(start_date, end_date) & 
      species %in% sel_species)
    if(length(sel_species)==1){
      plottitle <- paste("Tagesaktivität",format(start_date,format="%d.%m.%Y"),
        "bis",format(end_date,format="%d.%m.%Y"),"|",sel_species)
    } else {
      plottitle <- paste("Tagesaktivität",format(start_date,format="%d.%m.%Y"),
        "bis",format(end_date,format="%d.%m.%Y"))
    }
  }

  if(!is.null(plotTitle)){
    plottitle <- plotTitle
  }

  if(is.null(x_limits)){
    x_limits <- c(start_date,end_date)
  }
  
  period_nights <- seq(start_date,end_date,by="days")
  gps_coords <- ddply(plotData_sub,.(ProjectName),summarize,
    lat=lat[1],long=long[1])

  sun_data <- ddply(gps_coords,.(ProjectName),cbind,period_nights)
  names(sun_data)[4] <- "SurveyDate"

  gps_matrix <- matrix(c(sun_data$long,sun_data$lat),ncol=2)
  sun_data$sunset <- sunriset(
    gps_matrix,sun_data$SurveyDate,
    direction="sunset", POSIXct.out=TRUE)[,2]
  sun_data$sunrise <- sunriset(
    gps_matrix,sun_data$SurveyDate+24*60*60,
    direction="sunrise", POSIXct.out=TRUE)[,2]

  plotData_final <- merge(plotData_sub,sun_data,all=TRUE)
  plotData_final$time <- timeOfNight(plotData_final$bins)
  plotData_final$sunrise_time <- timeOfNight(plotData_final$sunrise)
  plotData_final$sunset_time <- timeOfNight(plotData_final$sunset)

  periodPlot <- ggplot(plotData_final,aes(SurveyDate,time))+
    geom_line(aes(SurveyDate,sunrise_time),
      size=0.3,color="grey25")+
    geom_line(aes(SurveyDate,sunset_time),
      size=0.3,color="grey25")+
    facet_wrap(~ProjectName,ncol = 2)+
    scale_x_datetime(limits=x_limits,breaks=date_breaks("months"),
      labels=date_format("%b %Y"))+
    scale_y_datetime(limits=y_limits,breaks=date_breaks("2 hour"),
      minor_breaks=date_breaks("1 hour"),
      labels = date_format("%H:%M"))+
    labs(x="Datum",y="Uhrzeit [UTC+1]",title=plottitle)

  if(sel_species[1]!="every" & length(sel_species)==1){
    periodPlot <- periodPlot+geom_point(aes(size=n_events),alpha=0.5,
      color="blue")
  } else {
    periodPlot <- periodPlot+geom_point(aes(size=n_events,color=species),
      alpha=0.5)
  }

  return(periodPlot)
}